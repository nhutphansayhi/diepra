<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Arial&display=swap" rel="stylesheet">
  <style>
  html { scroll-behavior: smooth; }
    body { 
      font-family: 'Arial', sans-serif; 
      max-width: 800px; 
      margin: 0 auto; 
      padding: 20px; 
      background-color: #f8f8f8; 
      color: #000; 
    }
  h1 { 
      font-family: 'Playfair Display', serif; 
      text-align: center; 
      font-size: 28px; 
      margin-bottom: 10px; 
    }
  h2 { text-align: center; margin: 0 0 10px; }
    p.intro { text-align: center; font-size: 16px; margin-bottom: 20px; }
    a#start-over, a#select-now { 
      display: block; 
      text-align: center; 
      margin: 10px 0; 
      color: #000; 
      text-decoration: underline; 
      cursor: pointer; 
    }
    #step-indicator { 
      text-align: center; 
      font-size: 14px; 
      color: #555; 
      margin-bottom: 10px; 
    }
    #quiz-container { max-width: 100%; }
  .question-section { display: none; margin-bottom: 30px; }
  .question-section.active { display: block; animation: fadeIn 240ms ease; }
  .question-section.completed { display: block; }
    .intensity-wrapper { text-align: center; }
    .faces { display: grid; grid-template-columns: repeat(auto-fit, minmax(96px, 1fr)); gap: 12px; margin-bottom: 10px; }
  .face { position: relative; text-align: center; opacity: 0.6; transition: opacity 0.3s, transform 0.2s; outline: none; aspect-ratio: 1 / 1; border-radius: 8px; overflow: hidden; }
  .face.selected { opacity: 1; transform: scale(1.035); }
    .face img { width: 100%; height: 100%; object-fit: cover; }
    .face-label { font-size: 12px; margin-top: 5px; }
    input[type="range"] { 
      width: 100%; 
      -webkit-appearance: none; 
      appearance: none; 
      height: 8px; 
      /* Two-layer background: progress overlay + base gradient */
      background: 
        linear-gradient(#4d2a12, #4d2a12) no-repeat, 
        linear-gradient(to right, #f0d9c7, #d2a679, #a56d3e, #7a4420, #4d2a12); 
      background-size: var(--progress, 0%) 100%, 100% 100%;
      background-position: left center, left center; 
      border-radius: 5px; 
      outline: none; 
      transition: background-size 160ms cubic-bezier(.22,.61,.36,1);
      will-change: background-size;
    }
    input[type="range"]::-webkit-slider-thumb { 
      -webkit-appearance: none; 
      appearance: none; 
      width: 20px; 
      height: 20px; 
      background: #fff; 
      border: 2px solid #000; 
      border-radius: 50%; 
      cursor: pointer; 
      transition: transform 0.12s ease, box-shadow 0.12s ease; 
    }
    input[type="range"].dragging::-webkit-slider-thumb { transform: scale(1.08); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    /* Firefox */
    input[type="range"]::-moz-range-thumb { 
      width: 20px; height: 20px; background: #fff; border: 2px solid #000; border-radius: 50%; cursor: pointer; transition: transform 0.12s ease, box-shadow 0.12s ease; 
    }
    input[type="range"].dragging::-moz-range-thumb { transform: scale(1.08); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    input[type="range"]::-moz-range-track { height: 8px; background: transparent; }
    .undertone-options, .options { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px; 
      margin: 20px 0; 
    }
    /* Tile grid for visual options */
    .tile-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin: 20px 0; }
    .tile-option { 
      position: relative; 
      aspect-ratio: 1 / 1; 
      background-size: cover; 
      background-position: center; 
      border-radius: 10px; 
      border: 4px solid transparent; 
      overflow: hidden; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      color: #0a1535; 
      letter-spacing: 0.06em; 
      font-weight: 800; 
      text-transform: uppercase; 
      cursor: pointer; 
    }
    .tile-option::after { 
      content: ""; 
      position: absolute; inset: 0; 
      background: linear-gradient(to bottom, rgba(255,255,255,0.55), rgba(255,255,255,0.15));
      pointer-events: none; 
    }
    .tile-option .tile-label { position: relative; z-index: 1; font-size: 18px; text-align: center; padding: 0 8px; }
    .tile-option.selected { border-color: #0a1535; box-shadow: 0 0 0 2px #0a1535 inset; }
    .option-box { 
      position: relative;
      aspect-ratio: 1 / 1; 
      background: #f5f0e6; 
      border-radius: 10px; 
      text-align: center; 
      cursor: pointer; 
      transition: background 0.2s, transform 0.1s, border-color 0.2s; 
      outline: none; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      border: 4px solid transparent;
      overflow: hidden;
    }
    .option-box.selected { background: #e0d8cc; border-color: #0a1535; box-shadow: 0 0 0 2px #0a1535 inset; }
    .option-box h3 { margin-bottom: 10px; }
    .option-box .thumb { position: absolute; inset: 0; background-size: cover; background-position: center; opacity: 0.9; }
    .option-box .label { position: relative; z-index: 1; font-weight: 800; letter-spacing: 0.06em; color: #0a1535; text-transform: uppercase; padding: 0 8px; }
    button.next { 
      display: block; 
      margin: 20px auto; 
      padding: 12px 24px; 
      background: #000; 
      color: #fff; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      font-weight: bold; 
      transition: background 0.3s ease; 
    }
    button.next:hover { background: #333; }
    button.next[disabled] { background: #888; cursor: not-allowed; opacity: 0.7; }
    #progress-bar { 
      height: 4px; 
      background: #ddd; 
      margin-bottom: 20px; 
      position: relative; 
    }
    #progress { 
      height: 100%; 
      background: linear-gradient(to right, #f0d9c7, #4d2a12); 
      width: 0%; 
      transition: width 0.5s ease; 
    }
    /* Summary bar */
  #answers-summary { 
      display: none; 
      grid-template-columns: repeat(4, 1fr); 
      gap: 16px; 
      align-items: stretch; 
      margin: 8px 0 16px; 
      padding: 10px 0; 
      border-top: 1px solid #ddd; 
      border-bottom: 1px solid #ddd; 
    }
    #answers-summary.visible { display: grid; }
    .summary-item { text-align: center; padding: 6px 8px; }
    .summary-item .label { font-size: 11px; letter-spacing: 0.12em; color: #666; font-weight: 800; }
    .summary-item .value { margin-top: 4px; font-size: 16px; text-decoration: underline; }

    /* Collapse/slide up animation for completed questions */
    .question-section.collapsing { 
      overflow: clip; 
      transition: height 260ms ease, opacity 220ms ease, margin 220ms ease; 
    }
    .question-section.collapsed { 
      height: 0 !important; 
      margin: 0 !important; 
      opacity: 0; 
      pointer-events: none; 
    }
    #results { 
      display: none; 
      margin-top: 30px; 
    }
    #results section { 
      margin-bottom: 30px; 
      padding: 20px; 
      background: #f5f5f5; 
      border-radius: 4px; 
    }
    .no-results { 
      color: #d32f2f; 
      text-align: center; 
      padding: 15px; 
      background: #ffebee; 
      border-radius: 4px; 
    }
    .product-img { 
      max-width: 100%; 
      height: auto; 
      margin: 10px 0; 
    }
    .results-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
  /* Product recommendations */
  .product-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-top: 16px; }
  .product-card { border: 1px solid #eee; border-radius: 10px; padding: 12px; background: #fff; display: flex; flex-direction: column; gap: 8px; }
  .product-card img { width: 100%; height: 160px; object-fit: contain; border-radius: 8px; background: #fafafa; }
  .product-card .pc-title { font-weight: 600; font-size: 14px; }
  .product-card .pc-cat { font-size: 12px; color: #666; }
  .product-card .pc-why { font-size: 12px; color: #333; }
  .product-card .pc-use { font-size: 12px; color: #2f6f2f; }
    .btn-secondary { 
      background: #fff; 
      color: #000; 
      border: 1px solid #000; 
      border-radius: 4px; 
      padding: 10px 16px; 
      cursor: pointer; 
      font-weight: 600; 
    }
    .btn-secondary:hover { background: #f0f0f0; }

    /* Modal */
    .modal-backdrop { 
      display: none; 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.4); 
      align-items: center; 
      justify-content: center; 
      z-index: 1000; 
    }
    .modal-backdrop.active { display: flex; }
    .modal { 
      background: #fff; 
      padding: 20px; 
      border-radius: 8px; 
      max-width: 640px; 
      width: 92%; 
      max-height: 86vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
    }
  .modal header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; position: sticky; top: 0; background: #fff; z-index: 1; }
    .modal h3 { margin: 0; }
    .close-modal { background: transparent; border: none; font-size: 20px; cursor: pointer; }
  .modal .row { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-top: 12px; }
  .modal .row .option-box { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; }
  .modal footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 14px; position: sticky; bottom: 0; background: #fff; padding-top: 10px; }

    /* Accessibility focus */
    .option-box:focus, .face:focus { outline: 3px solid #000; outline-offset: 2px; }

    /* Micro animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px);} to { opacity: 1; transform: translateY(0);} }

    @media (max-width: 600px) { 
      body { padding: 10px; } 
      h1 { font-size: 24px; } 
  .tile-grid { grid-template-columns: 1fr; gap: 12px; }
  #answers-summary { grid-template-columns: 1fr 1fr; }
      .modal .row .option-box { width: 100%; }
    }
  </style>
</head>
<body>
  <div id="quiz-container" data-scroll-offset="0">
    <h1>Find your 3/4/5-step skincare routine</h1>
    <p class="intro">Answer a few quick questions. If you don’t have acne, we’ll skip severity and move on. You’ll get a routine tailored to your skin and preferred complexity.</p>

    <a href="#" id="start-over">Start Over</a>

  <div id="progress-bar"><div id="progress"></div></div>
  <div id="step-indicator" aria-live="polite">Step 1/4</div>

    <!-- Answers Summary (fills as you answer; stays compact) -->
    <div id="answers-summary" aria-live="polite"></div>

  <!-- Removed Quick Select modal to simplify skincare flow -->

    <div id="q1" class="question-section active">
      <h2>Choose your skin type</h2>
      <div class="intensity-wrapper">
        <div class="faces" role="radiogroup" aria-label="Loại da">
          <div class="face" data-value="oily" data-label="OILY" tabindex="0"><img src="img/skin/SKIN_TYPE_-_OILY.jpg" alt="Oily"><div class="face-label">OILY</div></div>
          <div class="face" data-value="combination" data-label="COMBINATION" tabindex="0"><img src="img/skin/SKIN_TYPE_-_COMBINATION.jpg" alt="Combination"><div class="face-label">COMBINATION</div></div>
          <div class="face" data-value="dry" data-label="DRY" tabindex="0"><img src="img/skin/SKIN_TYPE_-_DRY.jpg" alt="Dry"><div class="face-label">DRY</div></div>
          <div class="face" data-value="normal" data-label="NORMAL" tabindex="0"><img src="img/skin/SKIN_TYPE_-_NORMAL.jpg" alt="Normal"><div class="face-label">NORMAL</div></div>
        </div>
      </div>
      <button class="next" data-next="q2" disabled>NEXT</button>
    </div>

    <div id="q2" class="question-section">
      <h2>Do you currently have acne?</h2>
      <div class="options" role="radiogroup" aria-label="Acne yes or no">
        <div class="option-box" data-value="yes" tabindex="0"><span class="label">YES</span></div>
        <div class="option-box" data-value="no" tabindex="0"><span class="label">NO</span></div>
      </div>
      <button class="next" data-next="q3" disabled>NEXT</button>
    </div>

    <div id="q3" class="question-section">
      <h2>How severe is your acne?</h2>
      <div class="options" role="radiogroup" aria-label="Acne severity">
        <div class="option-box" data-value="mild" tabindex="0"><span class="label">MILD</span></div>
        <div class="option-box" data-value="severe" tabindex="0"><span class="label">SEVERE</span></div>
      </div>
      <button class="next" data-next="q4" disabled>NEXT</button>
    </div>

    <div id="q4" class="question-section">
      <h2>How complex do you want your routine?</h2>
  <div class="options" role="radiogroup" aria-label="Routine complexity">
        <div class="option-box" data-value="simple" tabindex="0"><span class="label">SIMPLE (3 steps)</span></div>
        <div class="option-box" data-value="normal" tabindex="0"><span class="label">STANDARD (4 steps)</span></div>
        <div class="option-box" data-value="thorough" tabindex="0"><span class="label">THOROUGH (5 steps)</span></div>
      </div>
  <button class="next" data-next="results" disabled>SUBMIT</button>
    </div>

    <div id="results">
      <h2>Your recommended routine</h2>
      <p>We’ve tailored this routine to your skin profile and the complexity you prefer. AM/PM tips are included where helpful.</p>
      <section id="routine">
        <div class="routine-block" style="margin-bottom:12px;">
          <h3 style="margin:0 0 6px;">AM routine</h3>
          <ol id="routine-am" style="padding-left: 18px; line-height: 1.6;"></ol>
        </div>
        <div class="routine-block" style="margin-bottom:12px;">
          <h3 style="margin:0 0 6px;">PM routine</h3>
          <ol id="routine-pm" style="padding-left: 18px; line-height: 1.6;"></ol>
        </div>
        <p id="routine-notes" style="margin-top:10px; color:#444;"></p>
      </section>
      <section id="product-recos-section" style="margin-top: 18px;">
        <h3 style="margin-bottom:8px;">Recommended products for you</h3>
        <div id="product-recos" class="product-grid"></div>
      </section>
      <section>
        <div class="results-actions">
          <button class="btn-secondary" id="edit-answers">Edit Answers</button>
          <button class="btn-secondary" id="share-results">Share Results</button>
        </div>
      </section>
    </div>
  </div>

  <script>
    // State
  const questions = ['q1', 'q2', 'q3', 'q4'];
    const totalSteps = questions.length;
    const answers = {};
    const progress = document.getElementById('progress');
    const stepIndicator = document.getElementById('step-indicator');
    const startOver = document.getElementById('start-over');
  const resultsDiv = document.getElementById('results');
  const summary = document.getElementById('answers-summary');
    // Faces (skin type)
    const faces = document.querySelectorAll('.face');
  faces.forEach(face => {
      face.addEventListener('click', () => {
        faces.forEach(f => f.classList.remove('selected'));
        face.classList.add('selected');
        answers.skin_type = face.dataset.value;
        answers.skin_type_label = face.dataset.label || face.querySelector('.face-label')?.textContent || '';
        persistState();
        updateNextButtonState(document.getElementById('q1'));
        renderSummary();
  // Stay on this step; user advances via Next
      });
      face.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); face.click(); }
      });
    });

    // Option boxes (q2, q3)
  document.querySelectorAll('#q2 .option-box, #q3 .option-box, #q4 .option-box').forEach(box => {
      box.addEventListener('click', (e) => {
        const targetBox = e.currentTarget;
        const group = targetBox.closest('.options');
        const siblings = group.querySelectorAll('.option-box');
        siblings.forEach(s => s.classList.remove('selected'));
        targetBox.classList.add('selected');
        const qId = targetBox.closest('.question-section').id;
        const key = qId === 'q2' ? 'has_acne' : (qId === 'q3' ? 'acne_severity' : 'complexity');
        answers[key] = targetBox.dataset.value;
        answers[key + '_label'] = (targetBox.querySelector('.label')?.textContent || targetBox.textContent || '').trim();
        persistState();
        updateNextButtonState(targetBox.closest('.question-section'));
        renderSummary();
    // Stay on this step; user advances via Next
      });
      box.addEventListener('keydown', (ev) => { if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); box.click(); } });
    });

  // Next buttons
    document.querySelectorAll('.next').forEach(btn => {
      btn.addEventListener('click', (e) => {
        if (btn.hasAttribute('disabled')) return;
  const currentId = e.target.closest('.question-section').id;
  collapseThenNext(currentId);
      });
    });

    function updateProgress() {
      const currentIndex = questions.findIndex(q => document.getElementById(q).classList.contains('active'));
      const percent = currentIndex >= 0 ? ((currentIndex + 1) / questions.length) * 100 : 100;
      progress.style.width = `${percent}%`;
    }

    function updateStepIndicator() {
      const currentIndex = questions.findIndex(q => document.getElementById(q).classList.contains('active'));
      if (currentIndex >= 0) {
  stepIndicator.textContent = `Step ${currentIndex + 1}/${totalSteps}`;
      } else {
  stepIndicator.textContent = `Completed`;
      }
    }

    function updateNextButtonState(sectionEl) {
      if (!sectionEl) return;
      const btn = sectionEl.querySelector('.next');
      if (!btn) return;
      let enabled = true;
  if (sectionEl.id === 'q1') enabled = !!answers.skin_type;
  if (sectionEl.id === 'q2') enabled = !!answers.has_acne;
  if (sectionEl.id === 'q3') enabled = !!answers.acne_severity;
  if (sectionEl.id === 'q4') enabled = !!answers.complexity;
      if (enabled) btn.removeAttribute('disabled'); else btn.setAttribute('disabled', 'true');
    }

  // Summary renderer defined later

    // Collapse with animation then advance
    function collapseThenNext(currentId) {
      const el = document.getElementById(currentId);
      if (!el) { goToNextSection(currentId); return; }
      const startHeight = el.offsetHeight;
      el.style.height = startHeight + 'px';
      el.classList.add('collapsing');
      // reflow
      void el.offsetHeight;
      el.classList.add('collapsed');
      let finished = false;
      const done = () => {
        if (finished) return;
        finished = true;
        el.classList.remove('collapsing');
        el.classList.add('completed');
        el.style.height = '';
        goToNextSection(currentId);
      };
      const onEnd = (ev) => { if (ev.propertyName === 'height') { el.removeEventListener('transitionend', onEnd); done(); } };
      el.addEventListener('transitionend', onEnd);
      setTimeout(done, 380); // fallback
    }

    // Render compact answers summary bar
    function renderSummary() {
      const container = document.getElementById('answers-summary');
      if (!container) return;
      const items = [
  { key: 'skin_type', label: 'SKIN TYPE', value: (answers.skin_type_label || answers.skin_type) },
  { key: 'has_acne', label: 'ACNE', value: (answers.has_acne === 'yes' ? 'YES' : answers.has_acne === 'no' ? 'NO' : '') },
  { key: 'acne_severity', label: 'SEVERITY', value: (answers.acne_severity_label || (answers.has_acne === 'no' ? '—' : answers.acne_severity)) },
  { key: 'complexity', label: 'COMPLEXITY', value: (answers.complexity === 'simple' ? 'SIMPLE' : answers.complexity === 'normal' ? 'STANDARD' : answers.complexity === 'thorough' ? 'THOROUGH' : '') },
      ];
      const any = items.some(i => !!i.value);
      if (!any) { container.classList.remove('visible'); container.innerHTML = ''; return; }
      container.classList.add('visible');
      container.innerHTML = items.map(i => `
        <div class="summary-item">
          <div class="label">${i.label}</div>
          <div class="value">${(i.value || '').toString().replace(/-/g,' ')}</div>
        </div>
      `).join('');
    }

    // Auto-advance helper
    function goToNextSection(currentId) {
      const currentIndex = questions.indexOf(currentId);
      let nextId = currentIndex >= 0 && currentIndex < questions.length - 1 ? questions[currentIndex + 1] : 'results';
      // Skip Q3 (acne severity) if no acne in Q2; go to Q4
      if (currentId === 'q2' && answers.has_acne === 'no') {
        nextId = 'q4';
      }
      const currentEl = document.getElementById(currentId);
      if (currentEl) {
        currentEl.classList.remove('active');
        currentEl.classList.add('completed');
      }
      if (nextId !== 'results') {
        const nextEl = document.getElementById(nextId);
        if (nextEl) {
          nextEl.classList.add('active');
          updateNextButtonState(nextEl);
          updateProgress();
          updateStepIndicator();
          // Smooth scroll into view of next section
          smoothScrollTo(nextEl);
        }
      } else {
        showResults();
        smoothScrollTo(resultsDiv);
      }
    }

    function smoothScrollTo(el) {
      if (!el) return;
      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const offset = getScrollOffset();
      const parent = getScrollParent(el) || window;
      const rect = el.getBoundingClientRect();
      const currentScroll = parent === window ? window.pageYOffset : parent.scrollTop;
      const targetTop = currentScroll + rect.top - (parent === window ? offset : offsetWithin(parent)) - 6; // small visual margin
      if (prefersReduced) {
        if (parent === window) window.scrollTo(0, targetTop); else parent.scrollTo(0, targetTop);
        return;
      }
      if (parent === window) {
        window.scrollTo({ top: targetTop, behavior: 'smooth' });
      } else {
        parent.scrollTo({ top: targetTop, behavior: 'smooth' });
      }
    }

    function getScrollOffset() {
      const container = document.getElementById('quiz-container');
      const attr = container ? container.getAttribute('data-scroll-offset') : null;
      const n = Number(attr);
  return isFinite(n) ? n : 0; // customize via data-scroll-offset="64"
    }

    function getScrollParent(node) {
      if (!node) return window;
      let p = node.parentElement;
      while (p && p !== document.body) {
        const style = getComputedStyle(p);
        const overflowY = style.overflowY;
        if (overflowY === 'auto' || overflowY === 'scroll') return p;
        p = p.parentElement;
      }
      return window;
    }

    function offsetWithin(parent) {
      if (!parent || parent === window) return 0;
      const pr = parent.getBoundingClientRect();
      return pr.top;
    }

    // Lock scroll to the active question section to prevent navigating away by scroll
    function lockScrollToActive() {
      const active = document.querySelector('.question-section.active');
      if (!active) return;
      const offset = getScrollOffset();
      const rect = active.getBoundingClientRect();
      const targetTop = window.pageYOffset + rect.top - offset - 6;
      const tolerance = 4;
      // If user scrolls significantly away, snap back to the active section
      const delta = Math.abs(window.pageYOffset - targetTop);
      if (delta > tolerance) {
        window.scrollTo({ top: targetTop, behavior: 'instant' in window ? 'instant' : 'auto' });
      }
    }

    document.addEventListener('scroll', lockScrollToActive, { passive: true });

  function showResults() {
  // Required: skin_type, has_acne; if has_acne=yes, also acne_severity; and complexity
  if (!answers.skin_type || !answers.has_acne || (answers.has_acne === 'yes' && !answers.acne_severity) || !answers.complexity) {
  resultsDiv.innerHTML = '<p class="no-results">Please answer all questions to view your routine.</p>';
        resultsDiv.style.display = 'block';
        return;
      }

  const routine = buildRoutineSteps(answers);
  const amList = document.getElementById('routine-am');
  const pmList = document.getElementById('routine-pm');
  const notesEl = document.getElementById('routine-notes');
  amList.innerHTML = routine.am.map((s, i) => `<li><strong>Step ${i + 1}: ${s.title}</strong> — ${s.desc}</li>`).join('');
  pmList.innerHTML = routine.pm.map((s, i) => `<li><strong>Step ${i + 1}: ${s.title}</strong> — ${s.desc}</li>`).join('');
  notesEl.textContent = routine.notes || '';

      // Render product cards
      const recos = document.getElementById('product-recos');
      if (recos) {
        const picks = buildProductPicks(answers);
        recos.innerHTML = picks.map(p => `
          <div class="product-card">
            ${p.img ? `<img src="${p.img}" alt="${p.name}">` : ''}
            <div class="pc-cat">${p.category}</div>
            <div class="pc-title">${p.name}</div>
            <div class="pc-why">${p.why}</div>
            ${p.use ? `<div class="pc-use">${p.use}</div>` : ''}
          </div>
        `).join('');
      }

      resultsDiv.style.display = 'block';
      progress.style.width = '100%';
      renderSummary();
      updateStepIndicator();
      persistState(true);
    }

    function buildRoutineSteps(a) {
      const st = a.skin_type; // oily | combination | dry | normal
      const hasAcne = a.has_acne === 'yes';
      const sev = a.acne_severity; // mild | severe | undefined
      const cx = a.complexity || 'normal'; // simple | normal | thorough
      // Product catalog mapping
      const PRODUCTS = {
        cleanser: {
          name: 'Centella All-Rounder Ampoule Cleanser',
          desc: 'Calming, hydrating cleanser with high-quality Madagascan Centella Asiatica to soothe redness and irritation.',
          match: 'Best for Sensitive, Acne, Normal skin.',
          keys: 'Key: Centella Asiatica Extract.'
        },
        remover: {
          name: 'Hyaluro-Centella Cleansing Milk',
          desc: 'Mild milk cleanser with 8 HA and Madagascar Centella Asiatica. Gently removes makeup, sunscreen, impurities; supports moisture barrier.',
          match: 'Best for Sensitive, Dry, Dehydrated, Normal skin.',
          keys: 'Key: Centella Asiatica, 8 HA, Ceramide NP, Panthenol, Jojoba Seed.'
        },
        acne: {
          name: 'Tea Tree + Pine Blemish Ampoule',
          desc: 'Non-comedogenic ampoule with Tea Tree, Pine, Cypress to support blemish-prone, sensitive, oily skin.',
          match: 'Best for Acne, Oily, Sensitive skin.',
          keys: 'Key: Centella, Tea Tree Leaf Water, Pine Leaf Extract, Evening Primrose, Cypress Water.'
        },
        moisturizer: {
          name: '100H Hydro-Collagen Cream',
          desc: 'Lightweight cream with 5 Hyaluronic Acids + Hydrolyzed Collagen for deep, long-lasting hydration (up to 100 hours).',
          match: 'Best for Sensitive, Normal, Dry skin.',
          keys: 'Key: Centella, Hyaluronic Acid, Hydrolyzed Collagen.'
        },
        sunscreen: {
          name: 'SPF 50+ PA++++ Ultra-Light Sun Shield',
          desc: 'Lightweight, non-sticky sunscreen with a dewy, no white-cast finish. Hydrates and soothes; reef-safe.',
          match: 'Suitable for all skin types, even sensitive.',
          keys: 'Key: Hyalu-Cica Formula, Baby Green Complex (7 extracts), UV filters.',
          how: 'Use as the last step of AM routine. Apply generously to all exposed areas.'
        }
      };

      const am = [];
      const pm = [];

      // PM: Makeup remover (thorough)
      if (cx === 'thorough') {
        pm.push({
          title: 'Makeup Remover',
          desc: `${PRODUCTS.remover.name} — ${PRODUCTS.remover.desc} ${PRODUCTS.remover.match} ${PRODUCTS.remover.keys} Use: At night when wearing makeup/sunscreen, before cleanser.`
        });
      }

      // AM Cleanser
      am.push({
        title: 'Cleanser',
        desc: `${PRODUCTS.cleanser.name} — ${PRODUCTS.cleanser.desc} ${PRODUCTS.cleanser.match} ${PRODUCTS.cleanser.keys}`
      });
      // PM Cleanser
      pm.push({
        title: 'Cleanser',
        desc: `${PRODUCTS.cleanser.name} — Gentle cleanse to remove the day and prep skin. ${PRODUCTS.cleanser.keys}`
      });

      // Treatment: integrate only when acne present and not simple
      if (hasAcne && cx !== 'simple') {
        const nuanceAm = 'Light layer or spot treatment if skin tolerates.';
        const nuancePm = sev === 'severe'
          ? 'Introduce slowly at night; patch-test; consult a dermatologist for persistent/severe acne.'
          : 'Use nightly or every other night; spot-apply on active blemishes.';
        // AM (optional if tolerable)
        am.push({
          title: 'Acne Treatment',
          desc: `${PRODUCTS.acne.name} — ${PRODUCTS.acne.desc} ${PRODUCTS.acne.match} ${PRODUCTS.acne.keys} Tips: ${nuanceAm}`
        });
        // PM (primary)
        pm.push({
          title: 'Acne Treatment',
          desc: `${PRODUCTS.acne.name} — ${PRODUCTS.acne.desc} ${PRODUCTS.acne.match} ${PRODUCTS.acne.keys} Tips: ${nuancePm}`
        });
      }

      // Moisturizer (AM/PM)
      am.push({
        title: 'Moisturizer',
        desc: `${PRODUCTS.moisturizer.name} — ${PRODUCTS.moisturizer.desc} ${PRODUCTS.moisturizer.match} ${PRODUCTS.moisturizer.keys}`
      });
      pm.push({
        title: 'Moisturizer',
        desc: `${PRODUCTS.moisturizer.name} — Lock in moisture overnight to support barrier recovery. ${PRODUCTS.moisturizer.keys}`
      });

      // Sunscreen (AM)
      am.push({
        title: 'Sunscreen',
        desc: `${PRODUCTS.sunscreen.name} — ${PRODUCTS.sunscreen.desc} ${PRODUCTS.sunscreen.match} ${PRODUCTS.sunscreen.keys} How: ${PRODUCTS.sunscreen.how}`
      });

      // Complexity simplification: if simple, remove treatment from AM/PM
      if (cx === 'simple') {
        const stripTreatment = arr => arr.filter(s => s.title !== 'Acne Treatment');
        return {
          am: stripTreatment(am),
          pm: stripTreatment(pm),
          notes: hasAcne
            ? 'Simple mode: Keep it gentle. At night, you may spot-treat active blemishes if needed and tolerated.'
            : 'Simple mode: Consistent cleanse → moisturize; sunscreen every AM.',
          for: st
        };
      }

      // Notes
      let notes = hasAcne
        ? 'Introduce actives slowly (1-2x/week), increase as tolerated. Support your barrier; avoid over-exfoliation.'
        : 'AM = Cleanser → Moisturizer → Sunscreen. PM = (Makeup Remover if needed) → Cleanser → Moisturizer.';

      return { am, pm, notes, for: st };
    }

    // Build product picks aligned with user choices
    function buildProductPicks(a) {
      const st = a.skin_type; // oily | combination | dry | normal
      const hasAcne = a.has_acne === 'yes';
      const sev = a.acne_severity;
      const cx = a.complexity || 'normal';

      // Image paths available in repo (fallback to none if missing)
      const IMG = {
        remover: 'img/product/moi 3d (1).png', // using available image as placeholder
        cleanser: 'img/product/cleanser (4).png',
        acne: 'img/product/cleanser (1).png', // placeholder if acne product image is not provided
        moisturizer: 'img/product/moisturizer (1).png',
        sunscreen: 'img/product/sunscreen (1).png'
      };

      // Same names as routine mapping
      const P = {
        remover: 'Hyaluro-Centella Cleansing Milk',
        cleanser: 'Centella All-Rounder Ampoule Cleanser',
        acne: 'Tea Tree + Pine Blemish Ampoule',
        moisturizer: '100H Hydro-Collagen Cream',
        sunscreen: 'SPF 50+ PA++++ Ultra-Light Sun Shield'
      };

      const picks = [];

      // Thorough: show remover
      if (cx === 'thorough') {
        picks.push({
          category: 'Makeup Remover', name: P.remover, img: IMG.remover,
          why: 'Use at night when wearing makeup/sunscreen; gentle milk removes impurities while supporting the barrier.',
          use: 'PM as needed before cleanser.'
        });
      }
      // Cleanser
      picks.push({
        category: 'Cleanser', name: P.cleanser, img: IMG.cleanser,
        why: 'Centella-based gentle cleanse to calm and hydrate. Suitable even for sensitive skin.',
        use: 'AM/PM after remover (if used).'
      });

      // Treatment
      if (hasAcne && cx !== 'simple') {
        picks.push({
          category: 'Acne Treatment', name: P.acne, img: IMG.acne,
          why: sev === 'severe' ? 'Targeted support for blemish-prone skin; introduce slowly and consult a dermatologist for persistent acne.' : 'Target active blemishes; nightly or every other night.',
          use: sev === 'severe' ? 'Start low frequency at night; patch-test; consider medical advice.' : 'Apply thin layer or spot-treat after cleansing.'
        });
      }

      // Moisturizer
      picks.push({
        category: 'Moisturizer', name: P.moisturizer, img: IMG.moisturizer,
        why: st === 'dry' ? 'Rich hydration with 5 HA + hydrolyzed collagen to support a dry barrier.' : 'Lightweight hydration to support barrier without heaviness.',
        use: 'AM/PM after treatment/essence.'
      });

      // Sunscreen
      picks.push({
        category: 'Sunscreen', name: P.sunscreen, img: IMG.sunscreen,
        why: 'Broad-spectrum daily protection with a comfortable, non-sticky finish.',
        use: 'AM as the last step. Apply generously to exposed areas.'
      });

      return picks;
    }

    startOver.addEventListener('click', (e) => {
      e.preventDefault();
      questions.forEach(q => {
        const el = document.getElementById(q);
        el.classList.remove('active','completed','collapsing','collapsed');
        el.style.height = '';
      });
      document.getElementById('q1').classList.add('active');
      resultsDiv.style.display = 'none';
      progress.style.width = '0%';
  Object.keys(answers).forEach(key => delete answers[key]);
      faces.forEach(f => f.classList.remove('selected'));
      document.querySelectorAll('.option-box').forEach(b => b.classList.remove('selected'));
      updateProgress();
      updateStepIndicator();
      updateNextButtonState(document.getElementById('q1'));
      localStorage.removeItem('beautyQuiz');
      history.replaceState({}, '', location.pathname);
  renderSummary();
    });
    // Removed Quick Select modal logic

    // Share and edit actions
    document.getElementById('edit-answers').addEventListener('click', () => {
      resultsDiv.style.display = 'none';
      document.getElementById('q1').classList.add('active');
      updateProgress();
      updateStepIndicator();
    });
    document.getElementById('share-results').addEventListener('click', async () => {
      const url = buildShareUrl(answers);
      try {
        await navigator.clipboard.writeText(url);
        alert('A shareable link has been copied to your clipboard.');
      } catch (_) {
        prompt('Copy your shareable link:', url);
      }
    });

    function buildShareUrl(a) {
      const params = new URLSearchParams(a);
      params.set('auto','1');
      return `${location.origin}${location.pathname}?${params.toString()}`;
    }

    // Persist/restore
    function persistState(includeResults = false) {
      const data = { answers, includeResults };
      localStorage.setItem('beautyQuiz', JSON.stringify(data));
      const url = new URL(location.href);
      url.searchParams.forEach((_, key) => { url.searchParams.delete(key); });
      Object.entries(answers).forEach(([k,v]) => { if (v) url.searchParams.set(k, v); });
      history.replaceState({}, '', `${url.pathname}?${url.searchParams.toString()}`);
    }

    function restoreStateFromStorage() {
      try {
        const raw = localStorage.getItem('beautyQuiz');
        if (!raw) return false;
        const data = JSON.parse(raw);
        if (!data || !data.answers) return false;
        Object.assign(answers, data.answers);
        applyAnswersToUI();
        if (data.includeResults) { showResults(); }
        return true;
      } catch { return false; }
    }

    function applyAnswersToUI() {
  // reset selections
  document.querySelectorAll('#q2 .option-box, #q3 .option-box, #q4 .option-box').forEach(b => b.classList.remove('selected'));

      // skin type faces
      faces.forEach(f => f.classList.remove('selected'));
      if (answers.skin_type) {
        const ft = document.querySelector(`.face[data-value="${answers.skin_type}"]`);
        if (ft) ft.classList.add('selected');
      }

      if (answers.has_acne) {
        const el = document.querySelector(`#q2 .option-box[data-value="${answers.has_acne}"]`); if (el) el.classList.add('selected');
      }
      if (answers.acne_severity) {
        const el = document.querySelector(`#q3 .option-box[data-value="${answers.acne_severity}"]`); if (el) el.classList.add('selected');
      }
      if (answers.complexity) {
        const el = document.querySelector(`#q4 .option-box[data-value="${answers.complexity}"]`); if (el) el.classList.add('selected');
      }

      // Reveal sections progressively so users can scroll back to edit
      syncSectionVisibility();
      updateNextButtonState(document.getElementById('q1'));
      updateNextButtonState(document.getElementById('q2'));
  updateNextButtonState(document.getElementById('q3'));
  updateNextButtonState(document.getElementById('q4'));
    }

    function syncSectionVisibility() {
      // Determine last answered index
      const keys = ['skin_type','has_acne','acne_severity','complexity'];
      let lastAnswered = -1;
      keys.forEach((k, i) => { if (answers[k]) lastAnswered = i; });
      questions.forEach((qid, i) => {
        const el = document.getElementById(qid);
        el.classList.remove('active');
        el.classList.remove('completed');
        if (i < lastAnswered) el.classList.add('completed');
      });
      if (lastAnswered >= 0 && lastAnswered < questions.length) {
        document.getElementById(questions[lastAnswered]).classList.add('completed');
        let nextIndex = Math.min(lastAnswered + 1, questions.length - 1);
        // If user selected no acne, skip Q3 and move to Q4
        if (answers.has_acne === 'no' && questions[nextIndex] === 'q3') {
          nextIndex = questions.indexOf('q4');
        }
        document.getElementById(questions[nextIndex]).classList.add('active');
      } else {
        document.getElementById('q1').classList.add('active');
      }
      updateProgress();
      updateStepIndicator();
    }

    function restoreStateFromUrl() {
      const params = new URLSearchParams(location.search);
      let changed = false;
  ['skin_type','has_acne','acne_severity','complexity'].forEach(k => {
        const v = params.get(k);
        if (v) { answers[k] = v; changed = true; }
      });
      if (changed) applyAnswersToUI();
  if (params.get('auto') === '1' && answers.skin_type && answers.has_acne && (answers.has_acne === 'no' || answers.acne_severity) && answers.complexity) { showResults(); }
    }

    // Removed modal focus trap & slider auto-advance

    // Initial progress and state
  updateProgress();
    updateStepIndicator();
  updateNextButtonState(document.getElementById('q1'));
  if (!restoreStateFromStorage()) restoreStateFromUrl();
  renderSummary();
  </script>
</body>
</html>